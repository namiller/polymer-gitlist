<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="git-user.html">
<link rel="import" href="time-formatter.html">
<dom-module id="git-elem">
  <template>
    <style>
      :host {
        display: inline-block;
        width: 100%;
      }
      h1 {
        margin-top: 0px;
      }
      p {
        font-size: 18px;
      }
      a {
        text-decoration: none;
      }
      git-user {
        float: right;
      }
      .readme {
        width: 100%;
        overflow: scroll;
      }
      .expand {
        width: 100%;
      }
      .info {
        padding-right: 10px;
        float: left;
        font-size: 10px;
        width: 100px;
      }
    </style>
    <git-user user="{{repoData.owner}}"></git-user>
    <a href="{{repoData.html_url}}"><h1>{{repoData.name}}</h1></a>
    <p>{{repoData.description}}</p>
    <div class="info">
      <span class="tag">Language:</span>
      <span class="value">{{repoData.language}}</span>
    </div>
    <div class="info">
      <span class="tag">Size:</span>
      <span class="value">{{repoData.size}}KB</span>
    </div>
    <br style="clear:both;"/>
    <div class="info">
      <span class="tag">Created:</span>
      <span class="value"><time-formatter date="{{repoData.created_at}}"></time-formatter></span>
    </div>
    <div class="info">
      <span class="tag">Modified:</span>
      <span class="value"><time-formatter date="{{repoData.updated_at}}"></time-formatter></span>
    </div>
    <paper-button hidden class="expand" on-click="toggleREADME"><iron-icon icon=[[_getIcon(showREADME)]]></iron-icon></paper-button>
    <iron-collapse opened="{{showREADME}}">
      <div class="content readme">
        <marked-element markdown="{{readmeMD}}">
          <div class="markdown-html"></div>
        </marked-element>
      </div>
    </iron-collapse>
    <iron-ajax id="APIajax"
      url="{{link}}" 
      method="GET"
      handle-as="json" 
      on-response="_gitResponse">
    </iron-ajax>
    <iron-ajax
      auto 
      url="[[generateReadmeURL(repoData.full_name, repoData.default_branch)]]"
      method="GET"
      handle-as="text" 
      on-response="_readmeResponse">
      </iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'git-elem',

      properties: {
        baseUrl: {
          type: String,
          value: 'https://api.github.com/repos',
          observer: '_fixLink',
        },

        user: {
          type: String,
          value: '',
          observer: '_fixLink',
        },

        repo: {
          type: String,
          value: '',
          observer: '_fixLink',
        },

        link: {
          type: String,
          value: '',
          observer: 'repoFetch',
        },

        repoData: {
          type: Object,
          value: {},
          reflect: true,
        },

        readmeMD: {
          type: String,
          value: "",
          reflect: true,
        },

        showREADME: {
          type: Boolean,
          value: false,
          reflect: true,
        },
      },

      _fixLink: function() {
        if (this.get('baseUrl') && this.get('user') && this.get('repo')) {
          this.set('link', this.get('baseUrl') + '/' + this.get('user') + '/' + this.get('repo'));
        }
      },
      
      _gitResponse: function(event, data) {
        this.set('repoData', data.xhr.response);
      },
      
      _readmeResponse: function(event, data) {
        this.set('readmeMD', data.xhr.response);
        this.$$('paper-button').hidden = false;
      },

      _getIcon: function(open) {
        return open?"icons:expand-less":"icons:expand-more";
      },

      toggleREADME: function() {
        this.set('showREADME', !this.get('showREADME'));
      },

      generateReadmeURL: function(name, branch) {
        if (!name || name == '' || !branch || branch == '') {
          return "";
        }
        return "https://raw.githubusercontent.com/" + name + "/" + branch + "/README.md";
      },

      repoFetch: function() {
        if (!this.get('repoData') && this.get('link')) {
          this.$$('#APIajax').generateRequest();
        }
      },

    });
  </script>
</dom-module>
